# Maintainer: Niche-Knack Apps <support@niche-knack.com>
pkgname=clip-dr
pkgver=0.12.2
pkgrel=1
pkgdesc="Audio cleaning and clip-making application with CPU-only ASR"
arch=('x86_64')
url="https://github.com/niche-knack/clip-dr"
license=('MIT')
depends=(
    'webkit2gtk-4.1'
    'gtk3'
    'cairo'
    'pango'
    'gdk-pixbuf2'
    'libappindicator-gtk3'
    'librsvg'
    'gstreamer'
    'gst-plugins-base'
    'gst-plugins-good'
)
makedepends=(
    'rust'
    'cargo'
    'nodejs'
    'npm'
    'clang'
    'cmake'
    'pkg-config'
    'openssl'
)
optdepends=(
    'gst-plugins-ugly: Additional audio format support'
    'gst-plugins-bad: Additional audio format support'
    'gst-libav: FFmpeg-based audio decoding'
)
provides=('clip-dr')
conflicts=('clip-dr-bin' 'clip-dr-git')
source=(
    "$pkgname-$pkgver.tar.gz::https://github.com/niche-knack/clip-dr/archive/v$pkgver.tar.gz"
)
sha256sums=('SKIP')

build() {
    cd "$srcdir/$pkgname-$pkgver"

    # Install frontend dependencies
    npm ci

    # Build frontend only (npx vite build, NOT tauri build which tries to bundle AppImage/deb)
    npx vite build

    # Build Rust backend
    cd src-tauri
    cargo build --release
}

package() {
    cd "$srcdir/$pkgname-$pkgver"

    # Install binary
    install -Dm755 "src-tauri/target/release/clip-dr" \
        "$pkgdir/usr/lib/$pkgname/clip-dr"

    # Install wrapper script with Intel GPU workaround
    install -Dm755 /dev/stdin "$pkgdir/usr/bin/clip-dr" << 'EOF'
#!/bin/bash
# Wrapper script for Clip Dr.
# Includes workaround for Intel Alder Lake+ GPU EGL issues

# Fix for WebKitGTK EGL initialization on Intel 12th gen+ iGPUs
export WEBKIT_DISABLE_DMABUF_RENDERER=1

# Optional: Uncomment if you still have issues
# export WEBKIT_DISABLE_COMPOSITING_MODE=1

exec /usr/lib/clip-dr/clip-dr "$@"
EOF

    # Install desktop file
    install -Dm644 /dev/stdin "$pkgdir/usr/share/applications/$pkgname.desktop" << EOF
[Desktop Entry]
Name=Clip Dr.
Comment=Audio cleaning and clip-making application
Exec=clip-dr %F
Icon=clip-dr
Terminal=false
Type=Application
Categories=AudioVideo;Audio;AudioVideoEditing;
MimeType=audio/mpeg;audio/x-wav;audio/flac;audio/ogg;audio/aac;
Keywords=audio;clip;clean;transcribe;whisper;
EOF

    # Install icons
    for size in 32 128 256; do
        if [[ -f "src-tauri/icons/${size}x${size}.png" ]]; then
            install -Dm644 "src-tauri/icons/${size}x${size}.png" \
                "$pkgdir/usr/share/icons/hicolor/${size}x${size}/apps/$pkgname.png"
        fi
    done

    # Install main icon
    if [[ -f "src-tauri/icons/icon.png" ]]; then
        install -Dm644 "src-tauri/icons/icon.png" \
            "$pkgdir/usr/share/icons/hicolor/512x512/apps/$pkgname.png"
    fi

    # Install license
    install -Dm644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE" 2>/dev/null || true
}
