# Development Flatpak manifest
# This uses a pre-built binary from the host system
# For production builds, use the full manifest with vendored dependencies

app-id: com.nicheknack.clip-dr
runtime: org.gnome.Platform
runtime-version: '48'
sdk: org.gnome.Sdk

command: clip-dr

finish-args:
  # Display access
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland

  # Audio access (PulseAudio/PipeWire)
  - --socket=pulseaudio

  # File access for opening/saving audio files
  - --filesystem=home
  - --filesystem=xdg-documents
  - --filesystem=xdg-music
  - --filesystem=xdg-download

  # GPU acceleration
  - --device=dri

  # Network access (for downloading whisper models on first run)
  - --share=network

  # Intel GPU workaround - fixes EGL initialization on Alder Lake+ iGPUs
  - --env=WEBKIT_DISABLE_DMABUF_RENDERER=1

modules:
  - name: clip-dr
    buildsystem: simple
    build-commands:
      # Install pre-built binary
      - install -Dm755 clip-dr /app/bin/clip-dr

      # Install bundled resources (whisper model)
      - install -Dm644 models/ggml-tiny.bin /app/bin/models/ggml-tiny.bin

      # Install icons
      - install -Dm644 icons/icon.png /app/share/icons/hicolor/512x512/apps/com.nicheknack.clip-dr.png
      - install -Dm644 icons/128x128.png /app/share/icons/hicolor/128x128/apps/com.nicheknack.clip-dr.png
      - install -Dm644 icons/32x32.png /app/share/icons/hicolor/32x32/apps/com.nicheknack.clip-dr.png

      # Install desktop file
      - install -Dm644 com.nicheknack.clip-dr.desktop /app/share/applications/com.nicheknack.clip-dr.desktop

      # Install metainfo
      - install -Dm644 com.nicheknack.clip-dr.metainfo.xml /app/share/metainfo/com.nicheknack.clip-dr.metainfo.xml

    sources:
      # Pre-built binary from host
      - type: file
        path: ../../src-tauri/target/release/clip-dr

      # Icons
      - type: dir
        path: ../../src-tauri/icons
        dest: icons

      # Bundled models (whisper-tiny for transcription)
      - type: dir
        path: ../../src-tauri/resources/models
        dest: models

      # Desktop file and metainfo
      - type: file
        path: com.nicheknack.clip-dr.desktop
      - type: file
        path: com.nicheknack.clip-dr.metainfo.xml
